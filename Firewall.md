# Firewall

Дословно - противопожалная стена, защита от бури.

## Netfilter

Работает на уровне ядра, iptable - оболочка над фаерволом. Iptables - более чёткая структура и понятие в сравнени с нетфильтром.
Состоит из 4 таблиц:

1. filter- фильтрация пакетов, которые нам идут.
2. mangle - Можем изменять саму структуру пакетов, изменить параметры заголовков пакетов. Провайдеры ограничивают раздачу инета. Если мы попытаемся включить раздачу на телефоне, провайдер блокирует(Фиксируется по ttl пакета.) Нельзя определить прокси жтой штукой. Провайдер устанавливает время жизни для пакета, 62 - 1 = 61, всё норм, но если прилетает 62, то значит пришел пакет извне, в договоре нет, пакет прибивается. В таблице mangle можно изменить ttl чтобы пакеты не прибивались.
3. nat - в этой таблице происходит подмена адресов, сетевая трансляция.
4. raw - пакет обрабатывается как набор нулей и единиц

Каждая таблица состоит из цепочек, у фильтра 3 - INPUT(пришли извне для нашей машины), FORWARD(пакеты которые проходят через нашу машину), OUTPUT(порождены на нашей машине и уходят куда-то). Помимо этих можно написать свои цепочки, и тогда можно из INPUT по определенному правилу его передать в нашу. Если какое-то правило, описанное в цепочке, применяется к нашему пакету, то применяется действие в соответствии с нашим правилом, и пакет дальше не идёт

## nat

Состоит из 4 таблиц , нужны будут *PREROUTING POSTROUTING*.

Мы получили пакет на внешний интерфейс, системе надо понять, куда отправлять, или его отправлять дальше или в нашей машине -> сначала выполняется PREROUTING

`PREROUTING -> filter(в зависимости от того что нам надо) -> POSTROUTING`

``` bash
sudo iptables -t filter -p INPUT -j ACCEPT
```

Задали правило по умолчанию

`Режим белого списка` Если ни одно правило не прошло, то прибивается.

`Режим чёрного списка` - Если ни одно правило не прошло, то пакет идёт дальше.

Мы хотим сделать так чтобы внутри пинг работал, а извне пинги не проходили.

```
enp0s8 ip - 192.168.15.0/24
enp0s3 ip - 1.1.1.1/24
```

с 3 не проходили пинги, а с 8 проходили

``` bash
sudo iptables -t filter -p OUTPUT -s ACCEPT
```

Ставим режимм белого списка

``` bash 
sudo iptables -t filter -p INPUT -j DROP
```

Разрешим всем пакетам из этой сети которые приходят на enp0s8 нормально пропускаться

``` bash
sudo iptables -t filter -A INPUT -p icmp(протокол) -i enp0s8 -j ACCEPT -s 192.168.15.0/24
```

### Режим чёрного списка

``` bash
sudo iptables -t filter -A INPUT -p icmp -i enp0s3 -j DROP

-A INPUT -p icmp -i enp0s8 -s !192.168.15.0/24 -j DROP
```

`!` - все адреса кроме того который идёт после !
